<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>‡¶ú‡ßÄ‡¶¨‡¶® ‡¶∏‡ßá‡¶¨‡¶æ ‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∏‡¶ø</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #00b894;
      --bg: #f0f3f7;
      --card: #ffffff;
      --text: #2d3436;
      --danger: #d63031;
      --radius: 20px;
    }

    * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; background-color: var(--bg); color: var(--text); padding-bottom: 110px; }

    header {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
      padding: 40px 20px 60px; text-align: center; color: white;
      border-radius: 0 0 40px 40px; box-shadow: 0 10px 25px rgba(0, 184, 148, 0.2);
    }
    header h1 { margin: 0; font-size: 26px; font-weight: 800; }
    header .proprietor { margin: 10px 0 0; font-size: 17px; font-weight: 700; background: rgba(0,0,0,0.1); display: inline-block; padding: 5px 15px; border-radius: 20px; }

    main { padding: 0 20px; margin-top: -30px; max-width: 500px; margin-left: auto; margin-right: auto; }
    
    .view { display: none; animation: slideUp 0.3s ease-out; }
    .view.active { display: block; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .stat-box { background: var(--card); padding: 15px; border-radius: var(--radius); box-shadow: 0 5px 15px rgba(0,0,0,0.05); text-align: center; margin-bottom: 15px; }
    
    .btn { 
      background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px;
      font-weight: 700; width: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; text-decoration: none; font-size: 14px;
    }
    .btn-excel { background: #1f6e43; margin-top: 15px; font-size: 16px; padding: 15px; }

    nav {
      position: fixed; bottom: 15px; left: 15px; right: 15px; background: #2d3436;
      display: flex; justify-content: space-around; padding: 12px; border-radius: 25px; z-index: 1000;
    }
    nav button { background: none; border: none; color: #b2bec3; font-size: 11px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
    nav button.active { color: var(--primary); }
    nav button svg { width: 20px; height: 20px; fill: currentColor; }

    .customer-card {
      background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 10px;
      display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--primary);
    }
    input, select { width: 100%; border: none; padding: 12px; outline: none; font-size: 16px; background: #fff; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; }
    
    footer { text-align: center; padding: 20px; color: #636e72; font-size: 13px; font-weight: bold; }
  </style>
</head>
<body>

  <header>
    <h1>‡¶ú‡ßÄ‡¶¨‡¶® ‡¶∏‡ßá‡¶¨‡¶æ ‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∏‡¶ø</h1>
    <div class="proprietor">‡¶™‡ßç‡¶∞‡ßã: ‡¶Æ‡ßã: ‡¶Æ‡¶§‡¶ø‡¶â‡¶∞ ‡¶∞‡¶π‡¶Æ‡¶æ‡¶® (‡¶∏‡ßÅ‡¶ú‡¶æ‡¶≤)</div>
  </header>

  <main>
    <section id="view-home" class="view active">
      <div class="stat-box"><h4>‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶¨‡¶ï‡ßá‡ßü‡¶æ</h4><h2 id="totalBakiHome" style="color:red; font-size:24px">‡ß≥‡ß¶</h2></div>
      <div class="stat-box">
          <p>‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</p>
          <button onclick="navigate('add')" class="btn">Ôºã ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      </div>
    </section>

    <section id="view-customers" class="view">
      <input id="search" placeholder="‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." onkeyup="searchCustomer()">
      <div id="customerGrid"></div>
    </section>

    <section id="view-add" class="view">
      <div class="stat-box">
        <h3>‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</h3>
        <input id="addName" placeholder="‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
        <input id="addPhone" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞">
        <input id="addVillage" placeholder="‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ/‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ">
        <button onclick="saveCustomer()" class="btn">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      </div>
    </section>

    <section id="view-report" class="view">
      <div class="stat-box">
        <h3 style="color: #1f6e43;">Excel ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</h3>
        <p style="font-size: 14px; color: #666;">‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ, ‡¶´‡ßã‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡ßü‡¶æ ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá‡•§</p>
        <button onclick="downloadMasterExcel()" class="btn btn-excel">üìä ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</button>
      </div>
    </section>

    <section id="view-detail" class="view">
      <div class="stat-box">
        <h2 id="cName">‡¶®‡¶æ‡¶Æ</h2>
        <p id="cInfo"></p>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <a id="callLink" class="btn" style="background:#2ecc71">üìû ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®</a>
          <button onclick="sendWhatsApp()" class="btn" style="background:#25d366">üí¨ ‡¶π‡ßã‡ßü‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™</button>
        </div>
        <div style="background:#f1f3f7; padding:15px; border-radius:15px; margin-top:15px;">
          <select id="entryType"><option value="baki">‡¶¨‡¶æ‡¶ï‡¶ø (Debt)</option><option value="joma">‡¶ú‡¶Æ‡¶æ (Payment)</option></select>
          <input type="number" id="salePrice" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£">
          <input type="text" id="saleProduct" placeholder="‡¶®‡ßã‡¶ü (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤)">
          <button onclick="saveEntry()" class="btn">‡¶∏‡ßá‡¶≠ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</button>
        </div>
        <div id="salesList" style="margin-top:15px; text-align:left"></div>
        <h2 id="grandTotal" style="color:red; text-align:right">‡¶¨‡¶ï‡ßá‡ßü‡¶æ: ‡ß≥‡ß¶</h2>
      </div>
    </section>
  </main>

  <nav>
    <button onclick="navigate('home')" id="nav-home" class="active"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>‡¶π‡ßã‡¶Æ</button>
    <button onclick="navigate('customers')" id="nav-customers"><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</button>
    <button onclick="navigate('report')" id="nav-report"><svg viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1s-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1z"/></svg>‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</button>
  </nav>

  <footer>Developed by: Fahim Shariar Jaman</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAv8kkam_BMPh9e3HbZboxV8P-DgcIodB4",
      authDomain: "pharmacy-management-b8af1.firebaseapp.com",
      projectId: "pharmacy-management-b8af1",
      storageBucket: "pharmacy-management-b8af1.firebasestorage.app",
      messagingSenderId: "999414606702",
      appId: "1:999414606702:web:4086b909849b32b3d22f7f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.navigate = (r) => {
      document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
      document.getElementById("view-" + r).classList.add("active");
      document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
      document.getElementById("nav-" + (r === 'detail' ? 'customers' : r))?.classList.add("active");
    };

    window.saveCustomer = async () => {
      const n = document.getElementById("addName").value, p = document.getElementById("addPhone").value, v = document.getElementById("addVillage").value;
      if(!n || !p) return alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶¶‡¶ø‡¶®");
      await addDoc(collection(db, "customers"), { name: n, phone: p, village: v });
      alert("‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá"); navigate('customers');
    };

    function loadCustomers() {
      onSnapshot(collection(db, "customers"), snap => {
        const grid = document.getElementById("customerGrid"); grid.innerHTML = "";
        snap.forEach(d => {
          const c = d.data();
          const div = document.createElement("div"); div.className = "customer-card";
          div.innerHTML = `<div><b>${c.name}</b><br><small>${c.phone}</small></div><span>‚ûú</span>`;
          div.onclick = () => openCustomer(d.id, c);
          grid.appendChild(div);
        });
      });
    }

    let currentTotal = 0;
    async function openCustomer(id, data) {
      window.currentCustomerId = id; window.currentCustomerPhone = data.phone;
      document.getElementById("cName").innerText = data.name;
      document.getElementById("cInfo").innerText = data.phone + " | " + data.village;
      document.getElementById("callLink").href = "tel:" + data.phone;
      navigate("detail");
      onSnapshot(query(collection(db, "entries"), where("customerId", "==", id)), snap => {
        const list = document.getElementById("salesList"); list.innerHTML = ""; let total = 0;
        snap.forEach(sDoc => {
          const s = sDoc.data();
          if(s.type === 'baki') total += s.amount; else total -= s.amount;
          list.innerHTML += `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:5px; font-size:14px;"><span>${s.note}</span><span style="color:${s.type=='baki'?'red':'green'}">${s.type=='baki'?'+':'-'} ‡ß≥${s.amount}</span></div>`;
        });
        currentTotal = total;
        document.getElementById("grandTotal").innerText = "‡¶¨‡¶ï‡ßá‡ßü‡¶æ: ‡ß≥" + total;
      });
    }

    window.saveEntry = async () => {
      const t = document.getElementById("entryType").value, a = Number(document.getElementById("salePrice").value), n = document.getElementById("saleProduct").value || '‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®';
      if(!a) return alert("‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®");
      await addDoc(collection(db, "entries"), { customerId: window.currentCustomerId, type: t, amount: a, note: n, timestamp: Date.now() });
      document.getElementById("salePrice").value = ""; document.getElementById("saleProduct").value = "";
    };

   
    window.downloadMasterExcel = async () => {
      alert("‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá... ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶ï‡ßü‡ßá‡¶ï ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
      try {
          const customersSnap = await getDocs(collection(db, "customers"));
          const entriesSnap = await getDocs(collection(db, "entries"));
          
          let reportData = [];
          let grandTotalBaki = 0;

          customersSnap.forEach(cDoc => {
            const c = cDoc.data();
            const cId = cDoc.id;
            let totalBaki = 0;
            
            
            entriesSnap.forEach(eDoc => {
              const e = eDoc.data();
              if(e.customerId === cId) {
                if(e.type === 'baki') totalBaki += e.amount;
                else totalBaki -= e.amount;
              }
            });

            grandTotalBaki += totalBaki;

            reportData.push({
              "‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ": c.name,
              "‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞": c.phone,
              "‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ/‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ": c.village || '-',
              "‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡ßü‡¶æ (‡¶ü‡¶æ‡¶ï‡¶æ)": totalBaki
            });
          });

          
          const ws = XLSX.utils.json_to_sheet(reportData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Baki Report");
          
          
          XLSX.writeFile(wb, "Dokan_Baki_Report.xlsx");
      } catch (e) {
          alert("‡¶≠‡ßÅ‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + e.message);
      }
    };

    window.sendWhatsApp = () => window.open(`https://wa.me/88${window.currentCustomerPhone}?text=${encodeURIComponent('‡¶Ü‡¶∏‡¶∏‡¶æ‡¶≤‡¶æ‡¶Æ‡ßÅ ‡¶Ü‡¶≤‡¶æ‡¶á‡¶ï‡ßÅ‡¶Æ, ‡¶ú‡ßÄ‡¶¨‡¶® ‡¶∏‡ßá‡¶¨‡¶æ ‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∏‡¶ø‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶ï‡ßá‡ßü‡¶æ: ‡ß≥'+currentTotal)}`);

    function updateStats() {
      onSnapshot(collection(db, "entries"), snap => {
        let total = 0;
        snap.forEach(d => {
          const s = d.data();
          if(s.type === 'baki') total += s.amount; else total -= s.amount;
        });
        document.getElementById("totalBakiHome").innerText = "‡ß≥" + total;
      });
    }

    window.searchCustomer = () => {
      let val = document.getElementById("search").value.toLowerCase();
      document.querySelectorAll(".customer-card").forEach(c => c.style.display = c.innerText.toLowerCase().includes(val) ? "flex" : "none");
    };

    loadCustomers(); updateStats();
  </script>
</body>
</html>
