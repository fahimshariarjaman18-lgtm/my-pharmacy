<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>‡¶ú‡ßÄ‡¶¨‡¶® ‡¶∏‡ßá‡¶¨‡¶æ ‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∏‡¶ø - ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --grad:#22c55e; --card:#ffffff; --text:#0f172a;
      --muted:#64748b; --primary:#22c55e; --border:#e2e8f0;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:#fff; font-family: sans-serif;
      background: radial-gradient(1000px 600px at 20% -10%, rgba(34,197,94,.35), transparent),
                  linear-gradient(135deg, var(--grad), var(--bg));
      min-height: 100vh;
    }
    header{padding:20px;text-align:center;background:rgba(0,0,0,.25)}
    nav{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;background:rgba(0,0,0,.35);padding:8px}
    nav button, .primary, .danger, .success{
      border:none; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer;
    }
    .primary, nav button{background:var(--primary);color:#063f2e}
    .danger{background:#ef4444;color:#fff}
    .success{background:#10b981;color:#fff; border: 1px solid #fff;}
    
    main{max-width:1000px;margin:0 auto;padding:16px}
    .view{display:none}.view.active{display:block}
    .card{background:var(--card);color:var(--text);border-radius:16px;padding:16px;margin-bottom:15px}
    label{display:block; margin-top:10px; color: var(--muted); font-size: 14px;}
    input{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px; margin-top:5px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .row{background:#f8fafc; border:1px solid var(--border); border-radius:10px; padding:10px; margin:6px 0; display:flex; justify-content:space-between; align-items:center}
    footer{text-align:center; padding:20px; font-size:12px; opacity:0.7}
    
    .total-baki-box { background: #ef4444; color: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); }
    .total-baki-box h2 { margin: 0; font-size: 32px; }
    .action-group { display: flex; gap: 10px; margin-top: 10px; }
    .action-group button { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; }
    .btn-baki { background: #ef4444; }
    .btn-joma { background: #10b981; }
    .comm-btn{ padding: 8px; border-radius: 8px; text-decoration: none; color: white; font-size: 12px; display: inline-block; margin-right: 5px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

  <div id="auth-view" class="view" style="display: flex; justify-content: center; align-items: center; height: 100vh;">
    <div style="background: white; color: black; padding: 25px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center;">
      <h2 style="color: var(--primary);">‡¶ú‡ßÄ‡¶¨‡¶® ‡¶∏‡ßá‡¶¨‡¶æ ‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∏‡¶ø</h2>
      <form id="loginForm">
        <label>‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label> <input type="email" id="email" placeholder="admin@email.com" required>
        <label>‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label> <input type="password" id="pass" placeholder="******" required>
        <button type="submit" class="primary" style="width:100%; margin-top:15px; padding:12px">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      </form>
      <p id="loginError" style="color:red; font-size:13px; margin-top:10px"></p>
    </div>
  </div>

  <div id="app-content" style="display:none">
    <header>
      <h1>‡¶ú‡ßÄ‡¶¨‡¶® ‡¶∏‡ßá‡¶¨‡¶æ ‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∏‡¶ø</h1>
      <p>‡¶™‡ßç‡¶∞‡ßã: ‡¶Æ‡ßã‡¶É ‡¶Æ‡¶§‡¶ø‡¶â‡¶∞ ‡¶∞‡¶π‡¶Æ‡¶æ‡¶® (‡¶∏‡ßÅ‡¶ú‡¶æ‡¶≤)</p>
    </header>

    <nav>
      <button data-route="home">‡¶π‡ßã‡¶Æ</button>
      <button data-route="customers">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</button>
      <button data-route="report">‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</button>
      <button data-route="add">‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</button>
      <button class="danger" id="logoutBtn">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
    </nav>

    <main>
      <section id="view-home" class="view">
        <div class="total-baki-box">
          <p style="margin:0; opacity:0.9;">‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ (‡¶∏‡¶¨ ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞)</p>
          <h2 id="allOverTotal">‡ß≥‡ß¶</h2>
        </div>
        <div class="card" style="text-align:center">
          <button class="success" id="downloadExcel" style="width:100%; padding:15px; font-size:18px;">üì• ‡¶™‡ßÅ‡¶∞‡ßã ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
        </div>
      </section>

      <section id="view-customers" class="view">
        <input id="searchBox" placeholder="‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶´‡ßã‡¶® ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®..." style="margin-bottom:15px">
        <div id="customerGrid" class="grid"></div>
      </section>

      <section id="view-report" class="view">
        <div class="card">
          <h3>üìÖ ‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</h3>
          <input type="date" id="reportDate" style="margin-bottom:15px">
          <div id="dayList"></div>
        </div>
      </section>

      <section id="view-add" class="view">
        <div class="card">
          <h3>‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
          <form id="addForm">
            <label>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label> <input name="name" required />
            <label>‡¶™‡¶ø‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ</label> <input name="fatherName" />
            <label>‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ/‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</label> <input name="village" />
            <label>‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label> <input name="phone" />
            <button class="primary" type="submit" style="margin-top:15px">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
          </form>
        </div>
      </section>

      <section id="view-detail" class="view">
        <div class="card">
          <h2 id="cName">‡¶®‡¶æ‡¶Æ</h2>
          <p id="cInfo" style="color:gray"></p>
          <div id="commActions" style="margin: 10px 0;"></div>
          <hr>
          
          <h3>‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h3>
          <input type="date" id="entryDate" style="margin-bottom:10px">
          <input type="text" id="entryDesc" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ (‡¶â‡¶¶‡¶æ: ‡¶®‡¶æ‡¶™‡¶æ/‡¶ú‡¶Æ‡¶æ)">
          <input type="number" id="entryAmount" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£">
          
          <div class="action-group">
            <button class="btn-baki" onclick="saveEntry('baki')">‚ûï ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="btn-joma" onclick="saveEntry('joma')">‚ûñ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶®‡¶ø‡¶®</button>
          </div>

          <hr>
          <h3>‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
          <div id="salesList"></div>
          <h3 id="grandTotal" style="text-align:right; color: #ef4444;">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: ‡ß≥‡ß¶</h3>
          <button class="danger" id="deleteCustomerBtn" style="margin-top:20px; width:100%">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
      </section>
    </main>

    <footer><p>Developed by: Fahim Shahriar Jaman</p></footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAv8kkam_BMPh9e3HbZboxV8P-DgcIodB4",
      authDomain: "pharmacy-management-b8af1.firebaseapp.com",
      projectId: "pharmacy-management-b8af1",
      storageBucket: "pharmacy-management-b8af1.firebasestorage.app",
      messagingSenderId: "999414606702",
      appId: "1:999414606702:web:4086b909849b32b3d22f7f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let allCustomers = [];
    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById("auth-view").style.display = "none";
        document.getElementById("app-content").style.display = "block";
        document.getElementById("entryDate").valueAsDate = new Date();
        document.getElementById("reportDate").valueAsDate = new Date();
        navigate("home");
        loadCustomers();
        loadAllOverTotal();
        loadDailyReport(document.getElementById("reportDate").value);
      } else {
        document.getElementById("auth-view").style.display = "flex";
        document.getElementById("app-content").style.display = "none";
      }
    });

    function loadAllOverTotal() {
      onSnapshot(collection(db, "sales"), (snap) => {
        let total = 0; snap.forEach(d => total += d.data().price);
        document.getElementById("allOverTotal").textContent = `‡ß≥${total}`;
      });
    }

    document.getElementById("loginForm").onsubmit = async (e) => {
      e.preventDefault();
      try { await signInWithEmailAndPassword(auth, document.getElementById("email").value, document.getElementById("pass").value); } 
      catch (err) { alert("‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°!"); }
    };

    document.getElementById("logoutBtn").onclick = () => signOut(auth);

    function navigate(route) {
      document.querySelectorAll("main .view").forEach(v => v.classList.remove("active"));
      document.getElementById("view-" + route).classList.add("active");
    }

    document.querySelectorAll("nav button[data-route]").forEach(btn => {
      btn.onclick = () => navigate(btn.dataset.route);
    });

    document.getElementById("addForm").onsubmit = async (e) => {
      e.preventDefault();
      const f = e.target;
      await addDoc(collection(db, "customers"), { name: f.name.value, fatherName: f.fatherName.value, village: f.village.value, phone: f.phone.value, createdAt: Date.now() });
      f.reset(); navigate("customers");
    };

    function loadCustomers() {
      onSnapshot(collection(db, "customers"), (snap) => {
        allCustomers = []; snap.forEach(d => allCustomers.push({id: d.id, ...d.data()}));
        renderCustomerGrid(allCustomers);
      });
    }

    function renderCustomerGrid(data) {
      const grid = document.getElementById("customerGrid"); grid.innerHTML = "";
      data.forEach(c => {
        const div = document.createElement("div"); div.className = "card";
        div.innerHTML = `<h4>${c.name}</h4><p>‡¶´‡ßã‡¶®: ${c.phone || '‡¶®‡ßá‡¶á'}</p><button class="primary">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</button>`;
        div.querySelector("button").onclick = () => openCustomer(c.id, c);
        grid.appendChild(div);
      });
    }

    document.getElementById("searchBox").oninput = (e) => {
      const term = e.target.value.toLowerCase();
      renderCustomerGrid(allCustomers.filter(c => c.name.toLowerCase().includes(term) || (c.phone && c.phone.includes(term))));
    };

    async function openCustomer(id, data) {
      document.getElementById("cName").textContent = data.name;
      document.getElementById("cInfo").textContent = `‡¶™‡¶ø‡¶§‡¶æ: ${data.fatherName || '‡¶®‡ßá‡¶á'} | ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ: ${data.village} | ‡¶´‡ßã‡¶®: ${data.phone}`;
      const commBox = document.getElementById("commActions");
      commBox.innerHTML = data.phone ? `<a href="tel:${data.phone}" class="comm-btn" style="background:#3b82f6">üìû ‡¶ï‡¶≤</a> <a href="https://wa.me/88${data.phone}" class="comm-btn" style="background:#25d366">üí¨ WhatsApp</a>` : '';
      
      window.currentCustomerId = id;
      navigate("detail");
      onSnapshot(query(collection(db, "sales"), where("customerId", "==", id)), (snap) => {
        const list = document.getElementById("salesList"); list.innerHTML = "";
        let total = 0;
        snap.forEach(d => {
          const s = d.data(); total += s.price;
          const row = document.createElement("div"); row.className = "row";
          row.innerHTML = `<span>${s.date}: ${s.product} (‡ß≥${s.price})</span><button class="danger" style="padding:4px 8px; font-size:10px" onclick="deleteSale('${d.id}')">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>`;
          list.appendChild(row);
        });
        document.getElementById("grandTotal").textContent = `‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: ‡ß≥${total}`;
      });
    }

    window.saveEntry = async (type) => {
      const date = document.getElementById("entryDate").value;
      const desc = document.getElementById("entryDesc").value;
      let amount = Number(document.getElementById("entryAmount").value);
      if(!desc || !amount) return alert("‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶ì ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¶‡¶ø‡¶®");
      
   
      if(type === 'joma') amount = -Math.abs(amount);
      else amount = Math.abs(amount);

      await addDoc(collection(db, "sales"), { customerId: window.currentCustomerId, date, product: desc, price: amount });
      document.getElementById("entryDesc").value = "";
      document.getElementById("entryAmount").value = "";
    };

    window.deleteSale = async (id) => { if(confirm("‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) await deleteDoc(doc(db, "sales", id)); };

    document.getElementById("reportDate").onchange = (e) => loadDailyReport(e.target.value);
    function loadDailyReport(d) {
      onSnapshot(query(collection(db, "sales"), where("date", "==", d)), (snap) => {
        const list = document.getElementById("dayList"); list.innerHTML = "";
        snap.forEach(sDoc => {
          const s = sDoc.data(); const cust = allCustomers.find(c => c.id === s.customerId);
          const row = document.createElement("div"); row.className = "row";
          row.innerHTML = `<div><b>${cust ? cust.name : 'Unknown'}</b><br><small>${s.product}</small></div><b style="color:${s.price > 0 ? 'red':'green'}">${s.price}</b>`;
          list.appendChild(row);
        });
      });
    }

    document.getElementById("downloadExcel").onclick = async () => {
      const report = [];
      const customers = await getDocs(collection(db, "customers"));
      const sales = await getDocs(collection(db, "sales"));
      const balances = {};
      sales.forEach(s => { const d = s.data(); balances[d.customerId] = (balances[d.customerId] || 0) + d.price; });
      customers.forEach(c => { const d = c.data(); report.push({ "‡¶®‡¶æ‡¶Æ": d.name, "‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ": d.village, "‡¶´‡ßã‡¶®": d.phone, "‡¶¨‡¶ï‡ßá‡ßü‡¶æ": balances[c.id] || 0 }); });
      const ws = XLSX.utils.json_to_sheet(report); const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü"); XLSX.writeFile(wb, "Report.xlsx");
    };

    document.getElementById("deleteCustomerBtn").onclick = async () => { if(confirm("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) { await deleteDoc(doc(db, "customers", window.currentCustomerId)); navigate("customers"); } };
  </script>
</body>
</html>
