<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>‡¶ú‡ßÄ‡¶¨‡¶® ‡¶∏‡ßá‡¶¨‡¶æ ‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∏‡¶ø - ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --grad:#22c55e; --card:#ffffff; --text:#0f172a;
      --muted:#64748b; --primary:#22c55e; --border:#e2e8f0;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:#fff; font-family: sans-serif;
      background: radial-gradient(1000px 600px at 20% -10%, rgba(34,197,94,.35), transparent),
                  linear-gradient(135deg, var(--grad), var(--bg));
      min-height: 100vh;
    }
    header{padding:20px;text-align:center;background:rgba(0,0,0,.25)}
    nav{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;background:rgba(0,0,0,.35);padding:8px}
    nav button, .primary, .danger, .success{
      border:none; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer;
    }
    .primary, nav button{background:var(--primary);color:#063f2e}
    .danger{background:#ef4444;color:#fff}
    .success{background:#10b981;color:#fff; border: 1px solid #fff;}
    
    main{max-width:1000px;margin:0 auto;padding:16px}
    .view{display:none}.view.active{display:block}
    .card{background:var(--card);color:var(--text);border-radius:16px;padding:16px;margin-bottom:15px}
    label{display:block; margin-top:10px; color: var(--muted); font-size: 14px;}
    input{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px; margin-top:5px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .row{background:#f8fafc; border:1px solid var(--border); border-radius:10px; padding:10px; margin:6px 0; display:flex; justify-content:space-between; align-items:center}
    footer{text-align:center; padding:20px; font-size:12px; opacity:0.7}
    
    #auth-view{ display: none; justify-content: center; align-items: center; height: 100vh; position: fixed; top: 0; left: 0; width: 100%; background: var(--bg); z-index: 1000; }
    #auth-view.active { display: flex; }
    .login-box{ background: white; color: black; padding: 25px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; }
    .comm-btn{ padding: 8px; border-radius: 8px; text-decoration: none; color: white; font-size: 12px; display: inline-block; margin-right: 5px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

  <div id="auth-view" class="view">
    <div class="login-box">
      <h2 style="color: var(--primary);">‡¶ú‡ßÄ‡¶¨‡¶® ‡¶∏‡ßá‡¶¨‡¶æ ‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∏‡¶ø</h2>
      <p style="color: gray;">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</p>
      <form id="loginForm">
        <label>‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label>
        <input type="email" id="email" placeholder="admin@email.com" required>
        <label>‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label>
        <input type="password" id="pass" placeholder="******" required>
        <button type="submit" class="primary" style="width:100%; margin-top:15px; padding:12px">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      </form>
      <p id="loginError" style="color:red; font-size:13px; margin-top:10px"></p>
    </div>
  </div>

  <div id="app-content" style="display:none">
    <header>
      <h1>‡¶ú‡ßÄ‡¶¨‡¶® ‡¶∏‡ßá‡¶¨‡¶æ ‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∏‡¶ø</h1>
      <p>‡¶™‡ßç‡¶∞‡ßã: Md. Motiur Rahman (Sujal)</p>
    </header>

    <nav>
      <button data-route="home">‡¶π‡ßã‡¶Æ</button>
      <button data-route="customers">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</button>
      <button data-route="add">‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</button>
      <button class="danger" id="logoutBtn">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
    </nav>

    <main>
      <section id="view-home" class="view">
        <div class="card" style="text-align:center">
          <h2>‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ!</h2>
          <p>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶Ü‡¶õ‡ßá‡•§</p>
          <hr>
          <button class="success" id="downloadExcel" style="width:100%; padding:15px; font-size:18px;">üì• ‡¶™‡ßÅ‡¶∞‡ßã ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
          <p style="font-size:12px; color:gray; margin-top:5px;">(‡¶∏‡¶¨‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ, ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ, ‡¶´‡ßã‡¶® ‡¶ì ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡ßü‡¶æ ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶Ü‡¶∏‡¶¨‡ßá)</p>
        </div>
      </section>

      <section id="view-customers" class="view">
        <input id="searchBox" placeholder="‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶´‡ßã‡¶® ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®..." style="margin-bottom:15px">
        <div id="customerGrid" class="grid"></div>
      </section>

      <section id="view-add" class="view">
        <div class="card">
          <h3>‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
          <form id="addForm">
            <label>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label> <input name="name" required />
            <label>‡¶™‡¶ø‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ</label> <input name="fatherName" />
            <label>‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ/‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</label> <input name="village" />
            <label>‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label> <input name="phone" />
            <button class="primary" type="submit" style="margin-top:15px">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
          </form>
        </div>
      </section>

      <section id="view-detail" class="view">
        <div class="card">
          <h2 id="cName">‡¶®‡¶æ‡¶Æ</h2>
          <p id="cInfo" style="color:gray"></p>
          <div id="commActions" style="margin: 10px 0;"></div>
          <hr>
          <h3>‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® / ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
          <p style="font-size: 12px; color: green;">* ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶≤‡ßá ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶Æ‡¶æ‡¶á‡¶®‡¶æ‡¶∏ (-) ‡¶ö‡¶ø‡¶π‡ßç‡¶® ‡¶¶‡¶ø‡¶® (‡¶â‡¶¶‡¶æ: -500)</p>
          <form id="saleForm" style="display:flex; gap:10px; flex-wrap:wrap">
            <input type="date" name="date" required style="width:auto">
            <input type="text" name="product" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£" required style="flex:1">
            <input type="number" name="price" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ" required style="width:100px">
            <button class="primary" type="submit">‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
          </form>
          <hr>
          <h3>‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
          <div id="salesList"></div>
          <h3 id="grandTotal" style="text-align:right; color: #ef4444;">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: ‡ß≥‡ß¶</h3>
          <button class="danger" id="deleteCustomerBtn" style="margin-top:20px">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
      </section>
    </main>

    <footer>
      <p>Developed by: Fahim Shahriar Jaman</p>
    </footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAv8kkam_BMPh9e3HbZboxV8P-DgcIodB4",
      authDomain: "pharmacy-management-b8af1.firebaseapp.com",
      projectId: "pharmacy-management-b8af1",
      storageBucket: "pharmacy-management-b8af1.firebasestorage.app",
      messagingSenderId: "999414606702",
      appId: "1:999414606702:web:4086b909849b32b3d22f7f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let allCustomers = [];

    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById("auth-view").classList.remove("active");
        document.getElementById("app-content").style.display = "block";
        navigate("home");
        loadCustomers();
      } else {
        document.getElementById("auth-view").classList.add("active");
        document.getElementById("app-content").style.display = "none";
      }
    });

    document.getElementById("loginForm").onsubmit = async (e) => {
      e.preventDefault();
      try {
        await signInWithEmailAndPassword(auth, document.getElementById("email").value, document.getElementById("pass").value);
      } catch (err) {
        document.getElementById("loginError").textContent = "‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°!";
      }
    };

    document.getElementById("logoutBtn").onclick = () => signOut(auth);

    function navigate(route) {
      document.querySelectorAll("main .view").forEach(v => v.classList.remove("active"));
      document.getElementById("view-" + route).classList.add("active");
    }

    document.querySelectorAll("nav button[data-route]").forEach(btn => {
      btn.onclick = () => navigate(btn.dataset.route);
    });

    document.getElementById("addForm").onsubmit = async (e) => {
      e.preventDefault();
      const f = e.target;
      await addDoc(collection(db, "customers"), { 
        name: f.name.value, 
        fatherName: f.fatherName.value, 
        village: f.village.value, 
        phone: f.phone.value, 
        createdAt: Date.now() 
      });
      f.reset();
      navigate("customers");
    };

    function loadCustomers() {
      onSnapshot(collection(db, "customers"), (snap) => {
        allCustomers = [];
        snap.forEach(docSnap => allCustomers.push({id: docSnap.id, ...docSnap.data()}));
        renderCustomerGrid(allCustomers);
      });
    }

    function renderCustomerGrid(data) {
      const grid = document.getElementById("customerGrid");
      grid.innerHTML = "";
      data.forEach(c => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `<h4>${c.name}</h4><p>‡¶´‡ßã‡¶®: ${c.phone || '‡¶®‡ßá‡¶á'}</p><button class="primary">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</button>`;
        div.querySelector("button").onclick = () => openCustomer(c.id, c);
        grid.appendChild(div);
      });
    }

    document.getElementById("searchBox").oninput = (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = allCustomers.filter(c => 
        c.name.toLowerCase().includes(term) || (c.phone && c.phone.includes(term))
      );
      renderCustomerGrid(filtered);
    };

    async function openCustomer(id, data) {
      document.getElementById("cName").textContent = data.name;
      document.getElementById("cInfo").textContent = `‡¶™‡¶ø‡¶§‡¶æ: ${data.fatherName || '‡¶®‡ßá‡¶á'} | ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ: ${data.village} | ‡¶´‡ßã‡¶®: ${data.phone}`;
      
      const phone = data.phone;
      const commBox = document.getElementById("commActions");
      commBox.innerHTML = phone ? `
        <a href="tel:${phone}" class="comm-btn" style="background:#3b82f6">üìû ‡¶ï‡¶≤</a>
        <a href="https://wa.me/88${phone}" class="comm-btn" style="background:#25d366">üí¨ WhatsApp</a>
        <a href="sms:${phone}" class="comm-btn" style="background:#6366f1">‚úâÔ∏è SMS</a>
      ` : `<p style="color:red; font-size:12px">‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶®‡ßá‡¶á</p>`;

      window.currentCustomerId = id;
      navigate("detail");
      const q = query(collection(db, "sales"), where("customerId", "==", id));
      onSnapshot(q, (snap) => {
        const list = document.getElementById("salesList");
        list.innerHTML = "";
        let total = 0;
        snap.forEach(d => {
          const s = d.data();
          total += s.price;
          const row = document.createElement("div");
          row.className = "row";
          row.innerHTML = `<span>${s.date}: ${s.product} (‡ß≥${s.price})</span><button class="danger" style="padding:4px 8px; font-size:10px" onclick="deleteSale('${d.id}')">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>`;
          list.appendChild(row);
        });
        document.getElementById("grandTotal").textContent = `‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: ‡ß≥${total}`;
      });
    }

    window.deleteSale = async (id) => {
      if(confirm("‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) await deleteDoc(doc(db, "sales", id));
    };

    document.getElementById("saleForm").onsubmit = async (e) => {
      e.preventDefault();
      const f = e.target;
      await addDoc(collection(db, "sales"), { customerId: window.currentCustomerId, date: f.date.value, product: f.product.value, price: Number(f.price.value) });
      f.reset();
    };

    // --- ‡¶è‡¶á ‡¶Ö‡¶Ç‡¶∂‡¶ü‡¶ø ‡ß®‡ß´‡ß¶+ ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ---
    document.getElementById("downloadExcel").onclick = async () => {
      const btn = document.getElementById("downloadExcel");
      btn.textContent = "‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®... ‡¶°‡¶æ‡¶ü‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá";
      btn.disabled = true;

      try {
        const reportData = [];
        const customersSnap = await getDocs(collection(db, "customers"));
        const allSalesSnap = await getDocs(collection(db, "sales"));
        
        // ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ‡¶ó‡ßÅ‡¶≤‡ßã‡¶ï‡ßá ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®‡ßã (‡¶Ø‡¶æ‡¶§‡ßá ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶π‡ßü)
        const salesByCustomer = {};
        allSalesSnap.forEach(sDoc => {
          const s = sDoc.data();
          if(!salesByCustomer[s.customerId]) salesByCustomer[s.customerId] = 0;
          salesByCustomer[s.customerId] += s.price;
        });

        // ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ ‡¶§‡ßà‡¶∞‡¶ø
        customersSnap.forEach(cDoc => {
          const c = cDoc.data();
          const totalDue = salesByCustomer[cDoc.id] || 0;
          
          reportData.push({
            "‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ": c.name,
            "‡¶™‡¶ø‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ": c.fatherName || "‡¶®‡ßá‡¶á",
            "‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ/‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ": c.village || "‡¶®‡ßá‡¶á",
            "‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞": c.phone || "‡¶®‡ßá‡¶á",
            "‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡ßü‡¶æ (‡ß≥)": totalDue
          });
        });

        const ws = XLSX.utils.json_to_sheet(reportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü");
        XLSX.writeFile(wb, "Jibon_Seba_Pharmacy_Baki_Report.xlsx");
      } catch (error) {
        alert("‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
      }

      btn.textContent = "üìä ‡¶™‡ßÅ‡¶∞‡ßã ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°";
      btn.disabled = false;
    };

    document.getElementById("deleteCustomerBtn").onclick = async () => {
      if(confirm("‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶ö‡¶≤‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
        await deleteDoc(doc(db, "customers", window.currentCustomerId));
        navigate("customers");
      }
    };
  </script>
</body>
</html>
